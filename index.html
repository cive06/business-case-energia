<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Investimento Energia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        input, select { background: #334155; border: 1px solid #475569; color: white; padding: 8px; border-radius: 6px; width: 100%; }
        .highlight { color: #38bdf8; font-weight: bold; }
        .sabatini-active { color: #fbbf24; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 border-b border-slate-700 pb-2 text-center md:text-left">Dashboard Analisi Investimento</h1>
        
        <div class="grid md:grid-cols-3 gap-6">
            <div class="card md:col-span-1">
                <h2 class="text-xl mb-4 text-slate-400 border-b border-slate-700 pb-2">Parametri</h2>
                <label class="block mb-1 text-sm">Investimento Totale (€)</label>
                <input type="number" id="inv" value="285000" oninput="calcola()">
                
                <label class="block mt-4 mb-1 text-sm">Risparmio Fotovoltaico (€/anno)</label>
                <input type="number" id="rfv" value="67461" oninput="calcola()">
                
                <label class="block mt-4 mb-1 text-sm">Risparmio Ottimizzatore (€/anno)</label>
                <input type="number" id="rot" value="5278" oninput="calcola()">

                <div class="mt-6 p-4 bg-slate-800 rounded-lg">
                    <label class="flex items-center cursor-pointer">
                        <span class="mr-3 text-sm font-medium">Includi Legge Sabatini</span>
                        <input type="checkbox" id="sabCheck" class="sr-only peer" onchange="calcola()">
                        <div class="relative w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 font-bold"></div>
                    </label>
                    <p class="text-[10px] text-slate-500 mt-2">Stimata al ~10% dell'investimento in 5 anni.</p>
                </div>
            </div>

            <div class="card md:col-span-2">
                <h2 class="text-xl mb-4 text-slate-400">Proiezione Cash Flow</h2>
                <canvas id="mainChart" height="150"></canvas>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-6">
            <div class="card">
                <h2 class="text-xl mb-4 text-slate-400">Sintesi Benefici</h2>
                <div class="space-y-4">
                    <div class="flex justify-between"><span>Vantaggio Fiscale IRES (24%):</span> <span id="det-tot" class="highlight">0 €</span></div>
                    <div id="sab-row" class="flex justify-between hidden text-amber-400"><span>Contributo Sabatini:</span> <span id="sab-val">0 €</span></div>
                    <div class="flex justify-between border-t border-slate-700 pt-2 text-xl"><span>Payback Period:</span> <span id="payback" class="text-green-400 font-bold">0 anni</span></div>
                </div>
            </div>

            <div class="card overflow-x-auto">
                <h2 class="text-xl mb-4 text-slate-400">Piano Rateale IRES</h2>
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="border-b border-slate-700 text-slate-500">
                            <th class="p-2">Anno</th>
                            <th class="p-2">Rata %</th>
                            <th class="p-2 text-right">Importo Rata (€)</th>
                        </tr>
                    </thead>
                    <tbody id="tabella-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let myChart;

        function calcola() {
            const inv = parseFloat(document.getElementById('inv').value) || 0;
            const rfv = parseFloat(document.getElementById('rfv').value) || 0;
            const rot = parseFloat(document.getElementById('rot').value) || 0;
            const hasSabatini = document.getElementById('sabCheck').checked;

            // Logica IRES: 24% dell'investimento
            const detrazioneIRES = inv * 0.24;
            document.getElementById('det-tot').innerText = detrazioneIRES.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });

            // Logica Sabatini: ~10% dell'investimento in 5 anni
            const totaleSabatini = hasSabatini ? inv * 0.10 : 0;
            const sabRow = document.getElementById('sab-row');
            if(hasSabatini) {
                sabRow.classList.remove('hidden');
                document.getElementById('sab-val').innerText = totaleSabatini.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
            } else {
                sabRow.classList.add('hidden');
            }

            const risparmioAnnuoEnergetico = rfv + rot;
            const beneficioTotale = detrazioneIRES + totaleSabatini + (risparmioAnnuoEnergetico * 11);
            const payback = inv / (risparmioAnnuoEnergetico + (detrazioneIRES/11) + (totaleSabatini/5));
            document.getElementById('payback').innerText = payback.toFixed(1) + " anni";

            // Popolamento Tabella Dinamica
            let html = '';
            let chartLabels = [];
            let chartData = [];
            let cumulativo = -inv;

            for (let i = 1; i <= 11; i++) {
                let perc = (i === 1 || i === 11) ? 2.16 : 4.32;
                let importoIRES = (detrazioneIRES / (11 * 4.32 / 100)) * (perc / 100); 
                // Semplificazione per mantenere le tue proporzioni esatte sulle rate:
                let quotaRata = (detrazioneIRES / 100) * (perc / 0.24); 
                // Correzione matematica diretta per le tue percentuali su 11 rate:
                let rataReale = detrazioneIRES * (perc / 43.2);

                let quotaSabatini = (i <= 5) ? totaleSabatini / 5 : 0;
                cumulativo += risparmioAnnuoEnergetico + rataReale + quotaSabatini;
                
                chartLabels.push("Anno " + i);
                chartData.push(cumulativo);

                html += `<tr class="border-b border-slate-800 hover:bg-slate-800/50 transition">
                    <td class="p-2 text-slate-400">${2025 + i}</td>
                    <td class="p-2">${perc}%</td>
                    <td class="p-2 text-right font-mono text-blue-400">${rataReale.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' })}</td>
                </tr>`;
            }
            document.getElementById('tabella-body').innerHTML = html;
            updateChart(chartLabels, chartData);
        }

        function updateChart(labels, data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cash Flow Cumulativo (€)',
                        data: data,
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        calcola();
    </script>
</body>
</html>
