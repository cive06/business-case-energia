<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy ROI Optimizer - Analisi Industriale 285k</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background-color: #020617; color: #f1f5f9; font-family: sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 24px; }
        input { background: #1e293b; border: 1px solid #334155; color: #38bdf8; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; font-size: 1.1rem; }
        label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; margin-bottom: 6px; display: block; font-weight: 700; }
        .stat-val { font-size: 1.6rem; font-weight: 800; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="report-content" class="max-w-7xl mx-auto space-y-8">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-800 pb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black tracking-tighter uppercase italic text-blue-500">Energy ROI <span class="text-white">Master 4.0</span></h1>
                <p class="text-slate-500 text-sm mt-1">Sincronizzato con foglio Excel: <span class="text-blue-400 font-bold uppercase tracking-widest italic">Iperammortamento 180%</span></p>
            </div>
            <div class="no-print">
                <button onclick="exportPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-black transition-all flex items-center gap-2 shadow-xl shadow-blue-900/40">
                    ESPORTA REPORT PDF
                </button>
            </div>
        </header>

        <div class="grid lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1 space-y-6 no-print">
                <div class="card border-t-8 border-blue-600 shadow-2xl">
                    <h3 class="text-xs font-black text-white mb-6 uppercase tracking-widest border-b border-slate-700 pb-2 text-center italic">Dati Progetto</h3>
                    <div class="space-y-6">
                        <div>
                            <label>Investimento (€)</label>
                            <input type="number" id="in_inv" value="285000" oninput="aggiorna()">
                        </div>
                        
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <h4 class="text-[10px] font-black uppercase text-blue-400 mb-4">Risparmio Energetico Annuo</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[10px]">Impianto FV (€)</label>
                                    <input type="number" id="in_fv" value="67461" oninput="aggiorna()">
                                </div>
                                <div>
                                    <label class="text-[10px]">Ottimizzatore (€)</label>
                                    <input type="number" id="in_opt" value="5278" oninput="aggiorna()">
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/20">
                            <p class="text-[10px] text-blue-400 font-bold uppercase mb-1 italic">IRES 4.0 Attiva</p>
                            <p class="text-[11px] text-slate-400">Maggiorazione automatica <span class="text-white font-bold">180%</span> (IRES 24%).</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card border-l-8 border-blue-600">
                        <label class="text-blue-400 uppercase tracking-tighter">Recupero Fiscale Totale</label>
                        <div class="stat-val text-white mono" id="out_fisco">0 €</div>
                        <p class="text-[10px] text-slate-500 mt-1 italic">IRES 24% su base 180%</p>
                    </div>
                    <div class="card border-l-8 border-emerald-500">
                        <label class="text-emerald-400 font-bold italic uppercase tracking-tighter">Punto di Pareggio</label>
                        <div class="stat-val text-white mono" id="out_payback">0 Anni</div>
                        <p class="text-[10px] text-slate-500 mt-1">Break-even stimato</p>
                    </div>
                    <div class="card border-l-8 border-amber-500">
                        <label class="text-amber-400 font-bold uppercase tracking-tighter">ROI Industriale Annuo</label>
                        <div class="stat-val text-white mono" id="out_roi">0 %</div>
                        <p class="text-[10px] text-emerald-500 mt-1 font-bold">Resa Finanziaria</p>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xs font-black text-slate-500 uppercase mb-6 tracking-widest italic border-b border-slate-800 pb-2">Proiezione Cash Flow (20 Anni)</h2>
                    <canvas id="mainChart" height="130"></canvas>
                </div>

                <div class="card overflow-x-auto shadow-2xl">
                    <h2 class="text-xs font-black text-slate-500 uppercase mb-6 tracking-widest italic border-b border-slate-800 pb-2 text-blue-400">Piano dei Flussi di Cassa (Cifre in Euro)</h2>
                    <table class="w-full text-left text-sm mono">
                        <thead>
                            <tr class="text-slate-500 border-b border-slate-800 uppercase text-[10px]">
                                <th class="pb-4 px-2">Anno</th>
                                <th class="pb-4 text-right">Risp. FV</th>
                                <th class="pb-4 text-right">Risp. Ottim.</th>
                                <th class="pb-4 text-right text-blue-400 font-bold">Fisco</th>
                                <th class="pb-4 text-right font-black text-white italic underline">Cash Flow Netto</th>
                            </tr>
                        </thead>
                        <tbody id="out_tabella" class="divide-y divide-slate-800 text-[11px]"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myChart;

        function aggiorna() {
            const inv = parseFloat(document.getElementById('in_inv').value) || 0;
            const fv_sav = parseFloat(document.getElementById('in_fv').value) || 0;
            const opt_sav = parseFloat(document.getElementById('in_opt').value) || 0;

            // FISCO SYNC EXCEL: IRES 24% su base Iperammortizzata 180%
            // Totale Beneficio: inv * 1.8 * 0.24 = inv * 0.432
            const totFisco = inv * 0.432;
            document.getElementById('out_fisco').innerText = totFisco.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });

            const rispAnnuo = fv_sav + opt_sav;
            const avgAnnualBenefit = (totFisco / 11) + rispAnnuo;
            const roi = (avgAnnualBenefit / inv) * 100;
            document.getElementById('out_roi').innerText = roi.toFixed(1) + " %";

            let labels = [], dataPoints = [], htmlTable = '', cumul = -inv;

            for (let i = 1; i <= 20; i++) {
                // Rate Fisco: 2.16% e 4.32% sull'investimento (Excel Logic)
                let rFisco = 0;
                if (i <= 11) {
                    let perc = (i === 1 || i === 11) ? 0.0216 : 0.0432;
                    rFisco = inv * perc;
                }
                
                let flusso = rispAnnuo + rFisco;
                cumul += flusso;
                labels.push(2025+i);
                dataPoints.push(cumul);

                if (i <= 11) {
                    htmlTable += `
                        <tr class="hover:bg-blue-900/10 transition-colors">
                            <td class="py-4 px-2 text-slate-500 font-bold">${2025+i}</td>
                            <td class="py-4 text-right">${fv_sav.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' })}</td>
                            <td class="py-4 text-right text-amber-500 font-bold">${opt_sav.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' })}</td>
                            <td class="py-4 text-right text-blue-400 font-bold">${rFisco.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' })}</td>
                            <td class="py-4 text-right font-black text-emerald-400 italic">+ ${flusso.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' })}</td>
                        </tr>`;
                }
            }

            document.getElementById('out_tabella').innerHTML = htmlTable;

            // Break-even (quando cumulativo passa da - a +)
            const pb = inv / (rispAnnuo + (totFisco / 11));
            document.getElementById('out_payback').innerText = pb.toFixed(1) + " Anni";

            // Render Grafico
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        borderWidth: 4,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#1e293b' }, ticks: { color: '#64748b' } },
                        x: { grid: { display: false }, ticks: { color: '#64748b' } }
                    }
                }
            });
        }

        function exportPDF() {
            const el = document.getElementById('report-content');
            const btns = document.querySelectorAll('.no-print');
            btns.forEach(b => b.style.display = 'none');
            html2pdf().set({
                margin: 0.5,
                filename: 'Report_ROI_Industrial_285k.pdf',
                html2canvas: { scale: 3, backgroundColor: '#020617' },
                jsPDF: { orientation: 'landscape' }
            }).from(el).save().then(() => btns.forEach(b => b.style.display = 'flex'));
        }

        window.onload = aggiorna;
    </script>
</body>
</html>
