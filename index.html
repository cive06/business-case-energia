<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy ROI Master Optimizer 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background-color: #020617; color: #f1f5f9; font-family: sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 20px; }
        input { background: #1e293b; border: 1px solid #334155; color: #38bdf8; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; }
        label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; margin-bottom: 5px; display: block; }
        .stat-val { font-size: 1.75rem; font-weight: 800; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="report-content" class="max-w-7xl mx-auto space-y-6">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-800 pb-6 gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tighter text-white uppercase italic">Energy ROI <span class="text-blue-500">Master</span></h1>
                <p class="text-slate-500 text-sm italic text-blue-400">Analisi Tecnica: BORLANDELLI E VOLPI SRL</p>
            </div>
            <div class="flex gap-3 no-print">
                <button onclick="exportPDF()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-bold transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    EXPORT PDF
                </button>
            </div>
        </header>

        <div class="grid lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-4 no-print">
                <div class="card border-t-4 border-blue-500">
                    <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">Parametri Tecnici</h3>
                    <div class="space-y-4">
                        <div>
                            <label>Consumo Annuo (kWh)</label>
                            <input type="number" id="consumo" value="8942" oninput="calcola()">
                        </div>
                        <div>
                            <label>Costo Energia (€/kWh)</label>
                            <input type="number" id="costoKwh" value="0.268" step="0.001" oninput="calcola()">
                        </div>
                        <div>
                            <label>Investimento Totale (€)</label>
                            <input type="number" id="inv" value="20000" oninput="calcola()">
                        </div>
                        <div>
                            <label>Efficienza Ottimizzatore (%)</label>
                            <input type="number" id="optEff" value="7" step="1" oninput="calcola()">
                        </div>
                        <div>
                            <label>Inflazione Energetica (%)</label>
                            <input type="number" id="infl" value="3" step="0.5" oninput="calcola()">
                        </div>
                        <div class="pt-2">
                            <label class="flex items-center cursor-pointer bg-slate-800 p-3 rounded-lg">
                                <span class="mr-3 text-xs font-bold text-blue-400">LEGGE SABATINI (10%)</span>
                                <input type="checkbox" id="sabCheck" class="sr-only peer" onchange="calcola()" checked>
                                <div class="relative w-11 h-6 bg-slate-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card border-emerald-900/50 bg-emerald-900/10">
                    <label class="text-emerald-500">Sostenibilità</label>
                    <div class="text-2xl font-black text-emerald-400"><span id="co2">0</span> <span class="text-sm font-normal text-slate-400 uppercase">tCO2/y</span></div>
                    <p class="text-[10px] text-slate-500 mt-1">Equivalente a <span id="alberi" class="text-emerald-500 font-bold">0</span> alberi piantati/anno.</p>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="card border-l-4 border-blue-500">
                        <label>Vantaggio IRES (24%)</label>
                        <div class="stat-val text-blue-400 mono" id="ires-val">0 €</div>
                    </div>
                    <div class="card border-l-4 border-emerald-500">
                        <label>Tempo di Pareggio</label>
                        <div class="stat-val text-emerald-400 mono" id="pb-val">0 y</div>
                    </div>
                    <div class="card border-l-4 border-amber-500">
                        <label>Risp. Ottimizz./Anno</label>
                        <div class="stat-val text-amber-500 mono" id="opt-val">0 €</div>
                    </div>
                    <div class="card border-l-4 border-white text-right">
                        <label>Utile Netto (20 Anni)</label>
                        <div class="stat-val text-white mono" id="profit-val">0 €</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-tighter">Proiezione Cash Flow Cumulativo (20 Anni)</h2>
                    <canvas id="mainChart" height="130"></canvas>
                </div>

                <div class="card overflow-x-auto">
                    <h2 class="text-xs font-bold text-slate-500 uppercase mb-4 italic">Dettaglio Flussi primo decennio (Cifre in Euro)</h2>
                    <table class="w-full text-left text-sm mono">
                        <thead>
                            <tr class="text-slate-500 border-b border-slate-800 uppercase text-[10px]">
                                <th class="pb-3 px-2">Anno</th>
                                <th class="pb-3 text-right text-slate-400">Risp. Fotovolt.</th>
                                <th class="pb-3 text-right text-amber-500 font-bold">Risp. Ottimizz.</th>
                                <th class="pb-3 text-right text-blue-400">Fisco (IRES+Sab)</th>
                                <th class="pb-3 text-right font-bold text-white uppercase italic">Flusso Netto</th>
                            </tr>
                        </thead>
                        <tbody id="tab-body" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart;

        function calcola() {
            const inv = parseFloat(document.getElementById('inv').value) || 0;
            const cons = parseFloat(document.getElementById('consumo').value) || 0;
            const cost = parseFloat(document.getElementById('costoKwh').value) || 0;
            const effOpt = (parseFloat(document.getElementById('optEff').value) || 0) / 100;
            const infl = (parseFloat(document.getElementById('infl').value) || 0) / 100;
            const hasSab = document.getElementById('sabCheck').checked;

            const totIres = inv * 0.24;
            const totSab = hasSab ? inv * 0.10 : 0;
            
            document.getElementById('ires-val').innerText = totIres.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });

            // Calcolo automatico Risparmio Ottimizzatore base (sulla quota 30% prelevata da rete)
            const risparmioOptBase = (cons * cost * 0.3) * effOpt;
            document.getElementById('opt-val').innerText = risparmioOptBase.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });

            // Ambiente
            const tCO2 = (cons * 0.7 * 0.45) / 1000;
            document.getElementById('co2').innerText = tCO2.toFixed(1);
            document.getElementById('alberi').innerText = Math.round(tCO2 * 45);

            let labels = [], data = [], table = '', cumul = -inv, tot20 = -inv;

            for (let i = 1; i <= 20; i++) {
                let inflFact = Math.pow(1 + infl, i - 1);
                let rEner = (cons * cost * 0.7) * inflFact;
                let rOpt = risparmioOptBase * inflFact;
                
                let rIres = 0;
                if (i <= 11) {
                    let perc = (i === 1 || i === 11) ? 2.16 : 4.32;
                    rIres = totIres * (perc / 43.2);
                }

                let rSab = (i <= 5 && hasSab) ? totSab / 5 : 0;
                let flussoAnnuo = rEner + rOpt + rIres + rSab;
                
                cumul += flussoAnnuo;
                tot20 += (i <= 20) ? flussoAnnuo : 0;

                labels.push(i);
                data.push(cumul);

                if (i <= 11) {
                    table += `
                        <tr class="hover:bg-slate-800/50">
                            <td class="py-3 px-2 text-slate-500 font-bold">${2025+i}</td>
                            <td class="py-3 text-right">${rEner.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' })}</td>
                            <td class="py-3 text-right text-amber-50
